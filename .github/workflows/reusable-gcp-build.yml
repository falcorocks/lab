name: Build with Docker Build (Reusable)

on:
  workflow_call:
    inputs:
      image_name:
        description: 'Image name (e.g., gateway-backend)'
        required: true
        type: string
      context:
        description: 'Build context path'
        required: false
        default: '.'
        type: string
      platforms:
        description: 'Comma-separated list of platforms (e.g., linux/amd64,linux/arm64)'
        default: 'linux/amd64,linux/arm64'
        required: false
        type: string
      dockerfile:
        description: 'Path to Dockerfile relative to context'
        required: false
        type: string
        default: 'Dockerfile'
      extraTags:
        description: 'Additional tags (type=raw format). Default tags (type=sha, type=ref) are always included'
        required: false
        type: string
        default: ''
    secrets:
      project_id:
        description: 'GCP Project ID'
        required: true
      workload_identity_provider:
        description: 'GCP Workload Identity Provider'
        required: true
      registry:
        description: 'Container registry URL (e.g., us-docker.pkg.dev/project/repo)'
        required: true

jobs:
  build:
    runs-on: ubuntu-24.04
    permissions:
      contents: read
      id-token: write
      attestations: write
    
    steps:
      - name: harden-runner
        uses: step-security/harden-runner@v2
        with:
          egress-policy: audit

      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Docker meta
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ secrets.registry }}/${{ inputs.image_name }}
          tags: |
            type=sha
            type=ref,event=branch
            type=ref,event=tag
            ${{ inputs.extraTags }}
      
      - name: Authenticate to Google Cloud
        id: auth1
        uses: google-github-actions/auth@v3
        with:
          project_id: ${{ secrets.project_id }}
          workload_identity_provider: ${{ secrets.workload_identity_provider }}
          create_credentials_file: true

      - name: Configure Docker for GCP Artifact Registry
        run: gcloud auth configure-docker us-docker.pkg.dev --quiet
      
      - name: Build and push image
        id: build
        uses: docker/build-push-action@v6
        with:
          context: "{{defaultContext}}:${{ inputs.context }}"
          file: ${{ inputs.dockerfile }}
          platforms: ${{ inputs.platforms }}
          tags: ${{ steps.meta.outputs.tags }}
          push: true
          cache-from: type=gha
          cache-to: ${{ github.ref_protected && 'type=gha,mode=max' || '' }}

      - run: docker logout us-docker.pkg.dev

      - name: Re-authenticate to Google Cloud
        id: auth2
        uses: google-github-actions/auth@v3
        with:
          project_id: ${{ secrets.project_id }}
          workload_identity_provider: ${{ secrets.workload_identity_provider }}
  
      - name: Login to Artifact Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.registry }}
          username: oauth2accesstoken
          password: ${{ steps.auth2.outputs.auth_token }}

      - name: Attest build provenance
        uses: actions/attest-build-provenance@v3
        with:
          subject-name: ${{ secrets.registry }}/${{ inputs.image_name }}
          subject-digest: ${{ steps.build.outputs.digest }}
          push-to-registry: true
